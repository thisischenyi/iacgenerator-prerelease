{# AWS RDS Instance Terraform Template #}
{% set vpc_exists = properties.VPCExists | default('n') | lower %}
{% set sg_exists = properties.SecurityGroupsExist | default('n') | lower %}
{% set vpc = properties.VPC %}
{% set security_groups = properties.SecurityGroups %}
{% set subnets = properties.SubnetGroup_Subnets %}
{% set safe_res_id = resource_name | safe_id %}

{% if properties.DBSubnetGroupName %}
  {% set subnet_group_name = properties.DBSubnetGroupName %}
{% else %}
  {% set subnet_group_name = resource_name + "-subnet-group" %}
{% endif %}

{% if not properties.DBSubnetGroupName %}
resource "aws_db_subnet_group" "{{ safe_res_id }}" {
  name       = "{{ subnet_group_name }}"
  subnet_ids = [
    {% if subnets %}
      {% for subnet in (subnets if subnets is iterable else subnets.split(',')) %}
        {% set subnet_trimmed = subnet.strip() if subnet is string else subnet %}
        {% set subnet_exists = properties.SubnetExists | default('n') | lower %}
        {% if subnet_exists == 'y' %}
    "{{ subnet_trimmed }}"{{ "," if not loop.last else "" }}
        {% else %}
    aws_subnet.{{ subnet_trimmed | safe_id }}.id{{ "," if not loop.last else "" }}
        {% endif %}
      {% endfor %}
    {% endif %}
  ]

  tags = {
    Name        = "{{ subnet_group_name }}"
    Environment = "{{ properties.Environment }}"
    Project     = "{{ properties.Project }}"
  }
}
{% endif %}

resource "aws_db_instance" "{{ safe_res_id }}" {
  identifier     = "{{ resource_name }}"
  engine         = "{{ properties.Engine }}"
  engine_version = "{{ properties.EngineVersion }}"
  instance_class = "{{ properties.InstanceClass }}"
  
  allocated_storage     = {{ properties.AllocatedStorage }}
  storage_type          = "{{ properties.StorageType | default('gp3') }}"
  storage_encrypted     = {{ properties.StorageEncrypted | default('true') | lower }}
  {% if properties.KMS_Key_ID %}
  kms_key_id            = "{{ properties.KMS_Key_ID }}"
  {% endif %}
  
  db_name  = "{{ properties.DBName }}"
  username = "{{ properties.MasterUsername }}"
  password = "{{ properties.MasterPassword }}"  # WARNING: Store in secrets manager in production
  
  {% if not properties.DBSubnetGroupName %}
  db_subnet_group_name   = aws_db_subnet_group.{{ safe_res_id }}.name
  {% else %}
  db_subnet_group_name   = "{{ subnet_group_name }}"
  {% endif %}
  
  vpc_security_group_ids = [
    {% if security_groups %}
      {% set sgs = security_groups if security_groups is iterable and security_groups is not string else (security_groups.split(',') if security_groups is string else []) %}
      {% for sg in sgs %}
        {% set sg_trimmed = sg.strip() if sg is string else sg %}
        {% if sg_exists == 'y' %}
    "{{ sg_trimmed }}"{{ "," if not loop.last else "" }}
        {% else %}
    aws_security_group.{{ sg_trimmed | safe_id }}.id{{ "," if not loop.last else "" }}
        {% endif %}
      {% endfor %}
    {% endif %}
  ]
  
  multi_az               = {{ properties.MultiAZ | default('false') | lower }}
  publicly_accessible    = {{ properties.PubliclyAccessible | default('false') | lower }}
  
  backup_retention_period = {{ properties.BackupRetentionPeriod | default(7) }}
  {% if properties.PreferredBackupWindow %}
  preferred_backup_window = "{{ properties.PreferredBackupWindow }}"
  {% endif %}
  {% if properties.PreferredMaintenanceWindow %}
  preferred_maintenance_window = "{{ properties.PreferredMaintenanceWindow }}"
  {% endif %}
  
  auto_minor_version_upgrade = {{ properties.AutoMinorVersionUpgrade | default('true') | lower }}
  deletion_protection        = {{ properties.DeletionProtection | default('false') | lower }}
  
  skip_final_snapshot = true  # Set to false in production

  tags = merge(
    {
      Name        = "{{ resource_name }}"
      Environment = "{{ properties.Environment }}"
      Project     = "{{ properties.Project }}"
    },
    {% if properties.Tags %}{{ properties.Tags | to_hcl_map }}{% else %}{}{% endif %}
  )
}
