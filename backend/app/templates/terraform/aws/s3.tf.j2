{# AWS S3 Bucket Terraform Template #}
{% set safe_res_id = resource_name | safe_id %}
resource "aws_s3_bucket" "{{ safe_res_id }}" {
  bucket = "{{ properties.BucketName | default(resource_name) }}"

  tags = merge(
    {
      Name        = "{{ resource_name }}"
      Environment = "{{ properties.Environment | default('') }}"
      Project     = "{{ properties.Project | default('') }}"
    },
    {% if properties.Tags %}{{ properties.Tags | to_hcl_map }}{% else %}{}{% endif %}
  )
}

{% if properties.Versioning %}
resource "aws_s3_bucket_versioning" "{{ safe_res_id }}" {
  bucket = aws_s3_bucket.{{ safe_res_id }}.id

  versioning_configuration {
    status = "Enabled"
  }
}
{% endif %}

{% if properties.Encryption %}
resource "aws_s3_bucket_server_side_encryption_configuration" "{{ safe_res_id }}" {
  bucket = aws_s3_bucket.{{ safe_res_id }}.id

  rule {
    apply_server_side_encryption_by_default {
      sse_algorithm     = "{{ properties.EncryptionAlgorithm | default('AES256') }}"
      {% if properties.KmsKeyId %}
      kms_master_key_id = "{{ properties.KmsKeyId }}"
      {% endif %}
    }
  }
}
{% endif %}

{% if properties.PublicAccess == False or properties.PublicAccess == 'false' %}
resource "aws_s3_bucket_public_access_block" "{{ safe_res_id }}" {
  bucket = aws_s3_bucket.{{ safe_res_id }}.id

  block_public_acls       = true
  block_public_policy     = true
  ignore_public_acls      = true
  restrict_public_buckets = true
}
{% endif %}
