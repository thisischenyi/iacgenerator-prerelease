{# AWS EC2 Instance Terraform Template #}
{% set safe_res_id = resource_name | safe_id %}
{# If IngressRules are provided, create a security group first #}
{% if properties.IngressRules %}
resource "aws_security_group" "{{ safe_res_id }}_sg" {
  name        = "{{ resource_name }}-sg"
  description = "Security group for {{ resource_name }}"
  {% set vpc_exists = properties.VPCExists | default('n') | lower %}
  {% set vpc = properties.VPC %}
  {% if vpc_exists == 'y' %}
  vpc_id      = "{{ vpc }}"
  {% else %}
  vpc_id      = aws_vpc.{{ vpc | safe_id }}.id
  {% endif %}

  {% for rule in properties.IngressRules %}
  ingress {
    from_port   = {{ rule.from_port or rule.FromPort or rule.to_port or rule.ToPort or rule.Port or 0 }}
    to_port     = {{ rule.to_port or rule.ToPort or rule.from_port or rule.FromPort or rule.Port or 0 }}
    protocol    = "{{ rule.protocol or rule.Protocol or 'tcp' }}"
    cidr_blocks = {{ (rule.cidr_blocks or rule.CidrBlocks or ["0.0.0.0/0"]) | tojson }}
  }
  {% endfor %}

  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }

  tags = {
    Name = "{{ resource_name }}-sg"
  }
}
{% endif %}

resource "aws_instance" "{{ safe_res_id }}" {
  ami                         = "{{ properties.AMI_ID }}"
  instance_type               = "{{ properties.InstanceType }}"
  {% set subnet_exists = properties.SubnetExists | default('n') | lower %}
  {% set subnet = properties.Subnet %}
  {% if subnet_exists == 'y' %}
  subnet_id                   = "{{ subnet }}"
  {% else %}
  subnet_id                   = aws_subnet.{{ subnet | safe_id }}.id
  {% endif %}
  
  {% set sg_exists = properties.SecurityGroupsExist | default('n') | lower %}
  {% set security_groups = properties.SecurityGroups %}
  vpc_security_group_ids      = [
    {# Handle SecurityGroupIds field #}
    {% if properties.SecurityGroupIds %}
      {% set sg_ids = properties.SecurityGroupIds if properties.SecurityGroupIds is iterable and properties.SecurityGroupIds is not string else (properties.SecurityGroupIds.split(',') if properties.SecurityGroupIds is string else []) %}
      {% for sg in sg_ids %}
        {% set sg_trimmed = sg.strip() if sg is string else sg %}
        {% if sg_trimmed.startswith('sg-') %}
    "{{ sg_trimmed }}"{{ "," if not loop.last else "" }}
        {% else %}
    aws_security_group.{{ sg_trimmed | safe_id }}.id{{ "," if not loop.last else "" }}
        {% endif %}
      {% endfor %}
    {# Handle IngressRules - reference the security group created above #}
    {% elif properties.IngressRules %}
    aws_security_group.{{ safe_res_id }}_sg.id
    {% elif security_groups %}
      {% set sgs = security_groups if security_groups is iterable and security_groups is not string else (security_groups.split(',') if security_groups is string else []) %}
      {% for sg in sgs %}
        {% set sg_trimmed = sg.strip() if sg is string else sg %}
        {% if sg_exists == 'y' %}
    "{{ sg_trimmed }}"{{ "," if not loop.last else "" }}
        {% else %}
    aws_security_group.{{ sg_trimmed | safe_id }}.id{{ "," if not loop.last else "" }}
        {% endif %}
      {% endfor %}
    {% endif %}
  ]
  {% set keyname = properties.KeyPairName %}
  {% if keyname %}
  key_name                    = "{{ keyname }}"
  {% endif %}
  associate_public_ip_address = {{ properties.AssociatePublicIP | default('false') | lower }}
  monitoring                  = {{ properties.EnableMonitoring | default('false') | lower }}

  root_block_device {
    volume_size = {{ properties.RootVolumeSize | default(30) }}
    volume_type = "{{ properties.RootVolumeType | default('gp3') }}"
  }

  {% if properties.UserData %}
  user_data = <<-EOF
{{ properties.UserData }}
  EOF
  {% endif %}

  {% if properties.IAM_Role %}
  iam_instance_profile = "{{ properties.IAM_Role }}"
  {% endif %}

  tags = merge(
    {
      Name        = "{{ resource_name }}"
      Environment = "{{ properties.Environment | default('') }}"
      Project     = "{{ properties.Project | default('') }}"
    },
    {% if properties.Tags %}{{ properties.Tags | to_hcl_map }}{% else %}{}{% endif %}
  )
}