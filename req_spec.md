# AI驱动的Cloud IaC代码自动生成工具 - 功能需求文档

## 项目概述

**项目名称**: Cloud IaC Code Generator with Agentic AI

**目标**: 开发一个基于AI的智能体(Agentic AI)工具,通过理解用户需求自动生成符合安全合规标准的云基础设施即代码(IaC),支持AWS和Azure平台。

**核心技术栈**: 
- LangGraph框架(构建AI Agent,不使用LangChain)
- 可配置LLM(兼容OpenAI API)
- Accenture品牌UI设计

---

## 1. 功能需求

### 1.1 用户输入方式

#### 1.1.1 Excel文件上传方式

**功能描述**:
- 提供聊天界面,用户可上传包含云资源详细信息的Excel文件
- 系统提供Excel模板下载功能
- Excel文件采用多Sheet结构,每个Sheet对应一种资源类型

**Excel模板结构**:
- 参考“Excel模板字段定义规范.md”
- 每个Excel文件包含多个Sheet
- 每个Sheet代表一种特定的资源类型
- Sheet命名规范:
  - AWS资源: `AWS_[ResourceType]` (例如: `AWS_EC2`, `AWS_VPC`, `AWS_S3`)
  - Azure资源: `Azure_[ResourceType]` (例如: `Azure_VM`, `Azure_VNet`, `Azure_Storage`)
  - 说明Sheet: `README` (包含使用指南)

**支持的资源类型Sheet**(MVP阶段):

**AWS资源**:
- `AWS_EC2`: EC2虚拟机实例
- `AWS_VPC`: 虚拟私有云
- `AWS_Subnet`: 子网
- `AWS_SecurityGroup`: 安全组
- `AWS_S3`: S3存储桶
- `AWS_RDS`: 关系型数据库

**Azure资源**:
- `Azure_VM`: 虚拟机
- `Azure_VNet`: 虚拟网络
- `Azure_Subnet`: 子网
- `Azure_NSG`: 网络安全组
- `Azure_Storage`: 存储账户
- `Azure_SQL`: SQL数据库

**每个Sheet的列结构**:
- 包含该资源类型所需的所有字段
- 必填字段和可选字段明确区分
- 支持下拉列表的数据验证
- JSON格式字段用于复杂配置(如安全组规则、标签等)

**模板下载功能**:
- 提供三种模板选项:
  - AWS资源模板(仅AWS资源Sheet)
  - Azure资源模板(仅Azure资源Sheet)
  - 完整模板(包含所有AWS和Azure资源Sheet)
- 模板包含示例数据行
- 模板包含字段说明和填写指南

**文件上传处理**:
- 支持.xlsx和.xls格式
- 文件大小限制: 10MB
- 自动解析所有有效资源Sheet
- 生成解析摘要(资源类型数量、总资源数)
- 提供解析结果预览

#### 1.1.2 自然语言对话方式

**功能描述**:
- 提供聊天界面,用户通过自然语言描述云资源需求
- 支持多轮对话逐步收集完整信息。当用户提供的信息不完整时，Agent会主动询问，直到信息完整。
- 保留完整对话历史和上下文

**对话能力**:
- 理解用户的资源创建意图
- 识别资源类型和云平台
- 通过问答形式收集必要配置信息
- 支持用户修改已提供的信息
- 提供示例和选项帮助用户快速选择

**智能引导**:
- 根据资源类型自动生成问题清单
- 避免重复询问已提供的信息
- 显示信息收集进度
- 支持批量创建相似资源
- 支持关联资源自动创建(如创建EC2时自动创建VPC)

---

### 1.2 LLM集成

**功能描述**: 工具接入可配置的大语言模型

**集成要求**:
- 支持任何兼容OpenAI API规范的LLM端点
- 使用LangGraph框架构建AI Agent
- 实现标准的请求/响应处理

**配置项**:
- API端点URL
- API密钥(加密存储)
- 模型名称
- 温度参数(Temperature)
- 最大Token数(Max Tokens)
- 其他模型参数(Top P, Frequency Penalty等)
- 超时设置

**功能**:
- 提供"测试连接"功能验证配置
- 显示连接状态和最后成功时间
- API调用失败自动重试机制
- 记录API调用日志

---

### 1.3 智能需求处理能力

#### 1.3.1 信息完整性验证

**功能描述**: 判断用户提供的资源信息是否完整,如有缺失则要求用户补全

**Excel上传方式处理**:
- 解析Excel文件,识别所有资源Sheet
- 验证每个资源的必填字段是否完整
- 验证数据格式正确性(CIDR、JSON、IP地址等)
- 生成详细的验证报告,列出:
  - 验证通过的资源
  - 缺失必填字段的资源
  - 数据格式错误的资源
- 提供修正建议和示例
- 用户可选择:
  - 修正后重新上传
  - 仅处理验证通过的资源
  - 下载带错误标注的Excel文件

**自然语言方式处理**:
- 通过多轮对话收集信息
- 每轮对话后更新已收集信息列表
- 显示收集进度(已收集/待收集)
- 明确询问缺失的必填信息
- 提供选项和默认值帮助用户快速填写
- 收集完成后生成摘要供用户确认

**验证报告格式**:
- 清晰列出所有错误和警告
- 按资源类型和Sheet分组
- 提供具体的字段名称和错误描述
- 给出修正建议

#### 1.3.2 安全合规策略检查

**功能描述**: 验证资源配置是否符合预定义的安全合规策略

**策略定义功能**:
- 提供专门的"安全策略配置"界面(管理员功能)
- 支持通过自然语言定义策略规则
- AI将自然语言转换为可执行的验证规则
- 策略包含以下属性:
  - 策略名称
  - 策略描述
  - 自然语言规则定义
  - 适用云平台(AWS/Azure/全部)
  - 严重程度(Error错误级别/Warning警告级别)
  - 启用状态

**预定义策略示例**:
1. 禁止开放0.0.0.0/0访问3389端口(RDP)
2. 禁止开放0.0.0.0/0访问22端口(SSH)
3. 禁止开放0.0.0.0/0访问1433端口(SQL Server)
4. 禁止开放0.0.0.0/0访问3306端口(MySQL)
5. 禁止数据库服务启用公网访问
6. 所有存储服务必须启用加密
7. 生产环境数据库必须启用多可用区部署
8. 禁止数据库实例分配公网IP

**策略管理功能**:
- 查看所有策略列表
- 添加新策略(自然语言输入)
- 编辑现有策略
- 删除策略
- 启用/禁用策略
- 策略版本历史
- 策略测试功能
- 导入/导出策略

**策略检查流程**:
1. 在信息收集完成后执行
2. 加载所有已启用的策略
3. 根据资源类型过滤适用策略
4. 逐项检查每个资源配置
5. 生成合规检查报告

**违规处理**:
- 对于Error级别违规:
  - 阻止代码生成
  - 明确列出所有违规项
  - 提供修正建议
  - 要求用户修正后继续
  
- 对于Warning级别违规:
  - 显示警告信息
  - 允许用户选择:
    - 修正并继续
    - 接受风险并继续(需要确认理由)
    - 暂时忽略

**合规报告格式**:
- 列出所有违规项
- 说明违反了哪条策略
- 显示具体的违规配置
- 提供修正建议和示例

**审计功能**:
- 记录所有策略检查结果
- 记录用户对警告的处理决定
- 可导出合规报告

#### 1.3.3 IaC代码生成

**功能描述**: 基于验证通过的资源需求生成高质量的IaC代码

**支持的IaC格式**:
- Terraform (HCL语法,推荐,默认)


**代码生成要求**:
- 结构清晰,模块化组织
- 包含详细注释说明
- 遵循平台最佳实践
- 正确处理资源依赖关系
- 包含变量定义(variables)
- 包含输出定义(outputs)
- 使用统一的命名规范
- 添加资源标签(Tags)

**生成的文件结构**:
```
terraform/
├── main.tf           # 主配置文件
├── variables.tf      # 变量定义
├── outputs.tf        # 输出定义
├── provider.tf       # Provider配置
└── README.md         # 部署指南
```

**代码展示功能**:
- 在聊天界面右侧有一个代码预览窗口以代码块形式展示
- 提供语法高亮
- 显示生成的资源摘要
- 每个代码块提供"复制"按钮

**代码下载功能**:
- 单文件下载(每个.tf文件单独下载)
- 完整项目下载(ZIP压缩包)
- ZIP包包含:
  - 所有代码文件
  - README部署指南
  - terraform.tfvars.example示例文件

**代码验证**:
- 语法检查
- 资源引用完整性检查
- 参数必需性验证
- 依赖关系检查
- 生成代码质量评分
- 提供改进建议

**README文档生成**:
- 资源概述
- 部署前提条件
- 部署步骤说明
- 输出说明
- 清理资源说明
- 注意事项

### 1.3.4 自动化部署

**功能描述**: 允许用户直接从生成的代码执行Terraform部署操作

**环境管理**:
- 支持配置多个部署环境（如Dev, Staging, Prod）
- 存储云平台凭证（AWS Access Key/Secret, Azure Service Principal）
- 支持设置默认环境

**部署流程**:
1. **Plan预览**: 
   - 执行 `terraform plan`
   - 展示资源变更摘要（新增/修改/删除数量）
   - 显示详细的 plan 输出日志
   - 用户确认后才能继续

2. **Apply执行**:
   - 执行 `terraform apply`
   - 实时显示执行状态
   - 部署完成后显示 `terraform output` 结果
   - 记录部署历史和日志

3. **资源销毁**:
   - 支持对已部署环境执行 `terraform destroy`
   - 需要二次确认

---

### 1.4 云平台支持

#### 1.4.1 AWS资源支持

**MVP阶段支持的资源类型**:
- EC2: 虚拟机实例
- VPC: 虚拟私有云
- Subnet: 子网
- Security Group: 安全组
- S3: 对象存储
- RDS: 关系型数据库

**命名规范**:
- 遵循AWS命名最佳实践
- 格式: `{project}-{environment}-{resource-type}-{identifier}`

#### 1.4.2 Azure资源支持

**MVP阶段支持的资源类型**:
- Virtual Machines: 虚拟机
- Virtual Network: 虚拟网络
- Subnet: 子网
- Network Security Group: 网络安全组
- Storage Account: 存储账户
- SQL Database: SQL数据库

**命名规范**:
- 遵循Azure命名约定
- 使用Azure推荐的资源类型缩写
- 格式: `{resource-type}-{project}-{environment}-{region}-{instance}`


---

## 2. AI Agent架构(LangGraph)

### 2.1 Agent工作流设计

**使用LangGraph框架构建状态机式的智能体**:
- 定义状态(State)维护对话和资源信息
- 定义节点(Nodes)表示处理步骤
- 定义边(Edges)表示流程转换
- 支持条件分支和循环

**核心节点**:
1. **Input Parser**: 解析用户输入(Excel或自然语言)
2. **Information Collector**: 收集和验证必要信息
3. **Compliance Checker**: 执行安全合规检查
4. **Code Generator**: 生成IaC代码
5. **Code Validator**: 验证生成的代码
6. **Response Formatter**: 格式化输出响应

**工作流程**:
```
开始 → Input Parser → Information Collector
                            ↓
                    (信息完整?) 
                      是 ↓  否 → 请求补充信息 → 等待用户输入
                            ↓
                    Compliance Checker
                            ↓
                    (合规?) 
                      是 ↓  否 → 提示违规 → 等待用户修正
                            ↓
                    Code Generator → Code Validator
                            ↓
                    Response Formatter → 结束
```

### 2.2 状态管理

**状态内容**:
- 用户输入类型和原始数据
- 会话信息(session_id, 对话历史)
- 解析后的资源配置
- 信息完整性检查结果
- 合规检查结果
- 生成的代码
- 系统消息和用户消息
- 流程控制标志

**状态持久化**:
- 保存到数据库(SQLite/PostgreSQL)
- 支持会话恢复
- 保留对话历史
- 记录用户偏好

---

## 3. 用户界面设计

### 3.1 Accenture品牌配色

**主要颜色**:
- 主色: #A100FF (Accenture Purple)
- 辅助色: #000000 (Black)
- 强调色: #FF6D00 (Orange)
- 背景色: #FFFFFF (White) / #F5F5F5 (Light Gray)
- 成功: #00C853 (Green)
- 警告: #FFB300 (Amber)
- 错误: #D32F2F (Red)

**应用**:
- 导航栏: Purple背景,白色文字
- 主要按钮: Purple背景,白色文字
- 次要按钮: 白色背景,Purple边框和文字
- 链接: Purple文字
- 代码块: 深色背景,语法高亮

### 3.2 界面布局
- 参考"UI_design.png"文件

**主界面组成**:
1. **顶部导航栏**:
   - Accenture Logo和应用名称
   - 设置按钮(打开配置面板)

2. **Excel模板下载区域**:
   - 醒目的"下载Excel模板"按钮
   - 提供三种模板选项(AWS/Azure/完整)
   - 使用说明链接

3. **聊天消息显示区域**:
   - 用户消息(右对齐,浅紫色背景)
   - AI消息(左对齐,白色背景)
   - 系统提示(居中显示)
   - 代码块(深色背景,语法高亮)
   - 每条消息显示时间戳
   - 代码消息包含"复制"和"下载"按钮

4. **输入区域**:
   - 文本输入框(支持多行)
   - 附件按钮(上传Excel)
   - 发送按钮

5. **代码预览窗口**:
   - 在聊天界面右侧
   - 显示生成的代码
   - 提供语法高亮
   - 每个代码块提供"复制"和"下载"按钮

6. **配置面板**(侧边栏滑出):
   - **LLM配置**:
     - API端点
     - API密钥
     - 模型名称
     - 参数调整
     - 测试连接
   
7. **安全合规策略管理**:
     - 策略列表
     - 添加/编辑/删除策略
     - 启用/禁用策略
   

### 3.3 交互功能

**文件上传**:
- 拖拽上传或点击选择
- 显示上传进度
- 显示文件名和大小
- 可取消上传

**消息交互**:
- 支持自动滚动到最新消息
- 代码块语法高亮
- 复制代码一键操作
- 下载文件一键操作

**错误提示**:
- 清晰的错误消息
- 提供解决建议
- 友好的用户引导

**加载状态**:
- 文件解析: 进度条
- AI思考中: 加载动画
- 代码生成中: 状态提示

---

## 4. 技术实现要求

### 4.1 后端技术栈

**必需技术**:
- Python 3.10+
- LangGraph (AI Agent编排)
- FastAPI (Web API)
- Pandas / Openpyxl (Excel处理)
- Pydantic (数据验证)

**数据存储**:
- SQLite或PostgreSQL (配置、策略、会话)
- Redis (可选,用于缓存)

**代码生成**:
- Jinja2 (模板引擎)
- 预定义的Terraform/CloudFormation/ARM模板

### 4.2 前端技术栈

**推荐技术**:
- React或Vue.js
- TypeScript
- UI组件库(定制Accenture配色)
- 代码高亮库(Prism.js或highlight.js)

**文件处理**:
- SheetJS (Excel预览)
- FileSaver.js (文件下载)

### 4.3 部署要求

**本地Python虚拟环境**:
- 部署在一个虚拟python环境中，避免依赖冲突

**部署选项**:
- 支持云部署(AWS/Azure)
- 支持本地部署

**安全性**:
- HTTPS强制
- API密钥加密存储
- 用户认证(可选)
- 审计日志

---

## 5. 数据模型

### 5.1 核心数据结构

**用户会话**:
- session_id
- user_id
- 对话历史
- 收集的资源信息
- 合规检查结果
- 生成的代码

**安全策略**:
- policy_id
- 策略名称
- 策略描述
- 自然语言规则
- 可执行规则(AI转换后)
- 适用云平台
- 严重程度
- 启用状态

**LLM配置**:
- config_id
- 配置名称
- API端点
- API密钥(加密)
- 模型参数
- 激活状态

---

## 6. 开发阶段规划

### Phase 1: MVP (最小可行产品)
**优先级**: 高

**功能范围**:
- 基础聊天界面(Accenture品牌)
- Excel模板下载和上传
- 自然语言输入
- LLM集成(OpenAI兼容API)
- 信息完整性检查
- 基础安全合规策略检查
- 生成Terraform代码(AWS: EC2+VPC+S3, Azure: VM+VNet+Storage)
- 代码显示和下载

### Phase 2: 核心功能增强
**优先级**: 高

**功能范围**:
- LangGraph Agent完整实现
- 更多资源类型支持
- 策略智能转换优化
- 配置管理界面完善
- 错误处理和用户引导优化
- 多种IaC格式支持
- **自动化部署功能 (Plan & Apply)**

### Phase 3: 高级功能
**优先级**: 中

**功能范围**:
- 成本估算
- 策略智能推荐
- 代码版本管理
- 团队协作功能
- (已移除: 部署建议 - 已在Phase 2实现)

### Phase 4: 企业级增强
**优先级**: 低

**功能范围**:
- SSO集成
- 高级审计报告
- 多租户支持
- API开放
- 性能优化

---

## 7. 质量要求

### 7.1 功能质量

**准确性**:
- 信息提取准确率 > 95%
- 策略检查准确率 > 98%
- 代码语法正确率 100%

**性能**:
- Excel解析 < 10秒
- 单轮对话响应 < 10秒
- 代码生成 < 15秒

**可用性**:
- 非技术用户能在5分钟内上手
- 错误提示清晰可操作
- 生成代码可直接使用

### 7.2 测试要求

**测试类型**:
- 单元测试
- 集成测试
- 端到端测试
- 用户验收测试

**测试覆盖**:
- Agent各节点功能
- Excel解析
- 策略检查逻辑
- 代码生成准确性
- LLM API集成

---

## 8. 文档要求

**用户文档**:
- 快速入门指南
- Excel模板填写说明
- 常见问题解答

**管理员文档**:
- 部署指南
- 配置说明
- 策略管理指南

**开发者文档**:
- 架构设计文档
- API文档
- 扩展指南

---

## 9. 成功标准

**功能完整性**:
- ✅ 支持Excel和自然语言两种输入方式
- ✅ 成功集成可配置的LLM(不使用LangChain)
- ✅ Excel采用多Sheet结构,每个Sheet对应一种资源类型
- ✅ 实现完整的信息验证流程
- ✅ 实现安全合规策略检查(自然语言定义策略)
- ✅ 生成可执行的IaC代码
- ✅ 支持AWS和Azure两大云平台
- ✅ 界面符合Accenture品牌标准
- ✅ 基于LangGraph构建Agent

**用户体验**:
- 非技术用户能快速上手
- 对话流程自然流畅
- 错误提示清晰
- 生成代码质量高

**技术质量**:
- 代码覆盖率 > 80%
- 无重大bug
- 性能达标
- 安全合规

---

## 附录

### A. 术语表
- **IaC**: Infrastructure as Code (基础设施即代码)
- **LLM**: Large Language Model (大语言模型)
- **LangGraph**: 用于构建有状态AI应用的图框架
- **Agentic AI**: 具备自主决策能力的AI系统

### B. 关键设计原则

**Excel模板设计**:
- 每个资源类型独立Sheet
- 不同资源类型有不同的字段要求
- 用户只需填写需要创建的资源类型对应的Sheet
- 提供清晰的字段说明和示例

**Agent设计**:
- 仅使用LangGraph
- 状态机清晰,流程可控
- 支持循环和条件分支
- 错误处理完善

**安全策略**:
- 支持自然语言定义
- AI自动转换为可执行规则
- Error级别强制,Warning级别可选
- 完整的审计日志

---

**文档版本**: 1.0  
**最后更新**: 2026-01-18  
